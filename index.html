<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>iptables TRACE utility</title>
	<script type="text/javascript" src="/static/js/jquery.min.js"></script>
	<link rel="stylesheet" href="/static/css/maindesign.css" media="screen" id="cssRef">
	<style>
	.filter_option, .filter_custom
	{
		background-color: transparent;
		border: none;
		border-bottom: 1px solid black;
		font-family: monospace;
	}
	#firewall, .trace_hit, .trace_details
	{
		font-family: monospace;
	}
	.filter_name
	{
		font-style: italic
	}
	#packet_list
	{
		display: inline;
		overflow: none;
	}
	#packet_list a
	{
		margin: 0 3px 0 3px;
	}
	#trace_result
	{
		overflow-y: auto;
		white-space: nowrap;
	}
	#trace_result table td
	{
		vertical-align: top;
		white-space: nowrap;
	}
	.hilight1
	{
		background-color: #FFFFB0;
	}
	.hilight2
	{
		background-color: yellow;
	}
	</style>
	<script type="text/javascript">
	
	AJAXURL = '/cgi-bin/private/iptables/ajax.php';
	
	function starttraceing()
	{
		$('#firewall').html('');
		clear_packetlist();
		clear_resultbox();

		var filter = {option:{}, custom:{}};
		$('.filter_option').each(function()
		{
			filter.option[this.name] = this.value;
		});
		filter.custom = $('.filter_custom').val();
		
		$.post(
			AJAXURL,
			{
				act: 'setup',
				filter: filter,
				debug: $('#chkb_debug').attr('checked') ? 1 : 0,
			},
			function(data, textStatus, xhr)
			{
				$('#rawoutput').text(data.text);
				$('#firewall').html(data.firewall.html);
				document.trace_timer = setInterval(refresh, 1500);
			},
			'json'
		);
	}
	
	function refresh()
	{
		$.getJSON(
			AJAXURL,
			{
				act: 'poll',
			},
			function(data, textStatus, xhr)
			{
				// console.log(data);
				if(data.text)
				{
					$('#rawoutput').text(data.text);
				}
				for(var pktid in data.packets)
				{
					$('#packet_list').append('<a href="javascript:select_packet(' + pktid + ');" data-pktid=' + pktid + '>' + pktid + '</a> ');
					document.packet_data[pktid] = data.packets[pktid];
				}
			}
		);
	}

	function hilight(obj, hilightlevel)
	{
		obj.each(function()
		{
			$(this).addClass('hilight' + (hilightlevel ? hilightlevel : '1'));
		});
	}

	function clear_hilights()
	{
		$('#firewall > span').each(function()
		{
			$(this).removeClass('hilight1');
			$(this).removeClass('hilight2');
		});
	}
	
	function clear_packetlist()
	{
		$('#packet_list').html('');
	}
	
	function clear_resultbox()
	{
		$('#trace_result').html('');
	}
	
	function scrolltorule(selector_encoded)
	{
		$('#firewall > span').each(function()
		{
			$(this).removeClass('hilight2');
		});

		var selector = decodeURI(selector_encoded);
		$('html, body').animate({scrollTop: $(selector).offset().top}, 1000, null, function(){ hilight($(selector), 2); });
	}
	
	function select_packet(pktid)
	{
		clear_hilights();
		clear_resultbox();
		
		var pkt = document.packet_data[pktid];
		var trace_result_html = '<table>';
		for(var stepid in pkt)
		{
			var step = pkt[stepid];
			var selector;

			if(step.level == 'policy')
			{
				selector = 'span[table="' + step.table + '"][chain="' + step.chain + '"]:not([rule])';
			}
			else if(step.level == 'return')
			{
				selector = 'span[table="' + step.table + '"][chain="' + step.chain + '"][rule="' + step.number + '"]';
				if($(selector).length == 0)
				{
					selector = 'span[table="' + step.table + '"][chain="' + step.chain + '"]';
				}
			}
			else if(step.level == 'rule')
			{
				selector = 'span[table="' + step.table + '"][chain="' + step.chain + '"][rule="' + step.number + '"]';
			}
			hilight($(selector));
			trace_result_html += '<tr><td class="trace_hit"><a href="javascript:scrolltorule(\''+encodeURI(selector)+'\');">'+step.table+':'+step.chain+':'+step.level+':'+step.number+'</a></td><td class="trace_details">'+step.fields+'</td></tr>';
		}
		trace_result_html += '</table>'
		$('#trace_result').html(trace_result_html);
	}
	
	function stoptraceing()
	{
		clearInterval(document.trace_timer);
		$.post(
			AJAXURL,
			{
				act: 'stop',
			},
			function(data, textStatus, xhr)
			{
				$('#rawoutput').text(data.text);
			},
			'json'
		);
	}
	
	$(document).ready(function()
	{
		document.packet_data = {};
		
		$('input[length].filter_option, input[length].filter_custom').each(function()
		{
			this.style.width = $(this).attr('length') * 8;
		});
	});
	</script>
</head>
<body>
	<div id=tileset></div>
	<div id=frame></div>
	<div id=content>

		<a href="about.html" style="float: right;">Help</a>

		<h2>iptables TRACE utility</h2>

		<fieldset>
			<legend>Filter</legend>
			<span class="filter_name">src ip:</span>&nbsp;<input type=text class="filter_option" name=s length=16 />
			<span class="filter_name">dst ip:</span>&nbsp;<input type=text class="filter_option" name=d length=16 />
			<span class="filter_name">proto:</span>&nbsp;<input type=text class="filter_option" name=p length=4 />
			<span class="filter_name">src port:</span>&nbsp;<input type=text class="filter_option" name=sport length=6 />
			<span class="filter_name">dst port:</span>&nbsp;<input type=text class="filter_option" name=dport length=6 />
			<small class="filter_name">custom&nbsp;options:</small>&nbsp;<input type=text class="filter_custom" name=custom length=50 />
			<br/><br/>
			<input type=button value="TRACE!" onClick="starttraceing();" />
			<input type=checkbox id=chkb_debug /><label for=chkb_debug>debug</label>
			<input type=button value="Refresh" onClick="refresh();" />
			<input type=button value="Stop" onClick="stoptraceing();" />
		</fieldset>

		<fieldset>
			<legend>Messages</legend>
			<pre id="rawoutput"></pre>
		</fieldset>

		<fieldset>
			<legend>Packets</legend>
			<div id="packet_list"></div>
		</fieldset>

		<fieldset>
			<legend>Trace</legend>
			<div id="trace_result"></div>
		</fieldset>

		<fieldset>
			<legend>Firewall</legend>
			<div id="firewall"></div>
		</fieldset>
	</div>
</body>
</html>
